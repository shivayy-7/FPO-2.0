package com.fpo.web.services;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Optional;
import java.util.Random;

import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.aashdit.framework.core.ServiceOutcome;
import com.fpo.web.entities.Farmer;
import com.fpo.web.entities.FarmerSubActMap;
import com.fpo.web.repositories.CasteRepository;
import com.fpo.web.repositories.FarmerRepository;
import com.fpo.web.repositories.FarmerSubActMapRepository;
import com.fpo.web.repositories.GenderRepository;
import com.fpo.web.repositories.SubActivityRepository;
import com.fpo.web.vos.FarmerDtls;
import com.fpo.web.vos.FarmerSubActMapVO;
import com.fpo.web.vos.FarmerVO;

import lombok.extern.slf4j.Slf4j;

@Service
@Slf4j
public class FarmerServiceImpl implements FarmerService {
	
	@Autowired private FarmerRepository farmerRepository;
	
	@Autowired private FarmerSubActMapRepository farmerSubActMapRepository;
	
	@Autowired private GenderRepository genderRepository;
	
	@Autowired private CasteRepository casteRepository;
	
	@Autowired private SubActivityRepository subActivityRepository;
	
	@Override
	public ServiceOutcome<FarmerDtls> manageFarmer(FarmerDtls farmerDtls) {
		ServiceOutcome<FarmerDtls> soc = new ServiceOutcome<FarmerDtls>();
		FarmerDtls farmerDtl = new FarmerDtls();
		FarmerVO farmerVO = new FarmerVO();
		Random rand = new Random();
		String currentTab = null;
		SimpleDateFormat adjustedFormat = new SimpleDateFormat("dd/MM/yyyy");
//		Farmer existingFarmer = null;
		try {
			
			Farmer existingFarmer = Optional.ofNullable(farmerDtls.getFarmerVO().getFarmerId())
						                        .flatMap(farmerRepository::findById)
						                        .map(farmer->{
						                        	BeanUtils.copyProperties(farmerDtls.getFarmerVO(), farmer);
						                        	farmer.setFarmerCode(farmerDtls.getFarmerVO().getFarmerCode());
						                        	farmer.setGender(Optional.ofNullable(farmerDtls.getFarmerVO().getGender().getGenderId()).isPresent() ? genderRepository.findById(farmerDtls.getFarmerVO().getGender().getGenderId()).get() : null);
						                        	farmer.setCaste(Optional.ofNullable(farmerDtls.getFarmerVO().getCaste().getCasteId()).isPresent() ? casteRepository.findById(farmerDtls.getFarmerVO().getCaste().getCasteId()).get() : null);
						                        	farmer.setActive(true);
						                        	farmer.setStatus(farmerDtls.getFarmerVO().getStatus());
						                        	try {
														farmer.setDob(adjustedFormat.parse(farmerDtls.getFarmerVO().getDob().trim()));
													} catch (ParseException e) {
														e.printStackTrace();
													}
						                        	return farmerRepository.save(farmer);
						                        })
						                        .orElseGet(()->{
						                        	Farmer newFarmer = new Farmer();
						                        	BeanUtils.copyProperties(farmerDtls.getFarmerVO(), newFarmer);
						                        	String farmerCode = "FARMER" + rand.ints(48, 100)
							  				        .filter(num -> (num < 58 || num > 64) && (num < 91 || num > 96))
							  				        .limit(6)
							  				        .mapToObj(c -> (char) c)
							  				        .collect(StringBuilder::new, StringBuilder::append, StringBuilder::append)
							  				        .toString();
						                        	newFarmer.setFarmerCode(farmerCode);
						                        	newFarmer.setGender(Optional.ofNullable(farmerDtls.getFarmerVO().getGender().getGenderId()).isPresent() ? genderRepository.findByGenderId(farmerDtls.getFarmerVO().getGender().getGenderId()) : null);
						                        	newFarmer.setCaste(Optional.ofNullable(farmerDtls.getFarmerVO().getCaste().getCasteId()).isPresent() ? casteRepository.findById(farmerDtls.getFarmerVO().getCaste().getCasteId()).get() : null);
						                        	newFarmer.setActive(true);
						                        	newFarmer.setStatus(farmerDtls.getFarmerVO().getStatus());
						                        	try {
						                        		newFarmer.setDob(adjustedFormat.parse(farmerDtls.getFarmerVO().getDob().trim()));
													} catch (ParseException e) {
														e.printStackTrace();
													}
						                        	return farmerRepository.save(newFarmer);
						                        });
			FarmerSubActMap farmerSubActMap = new FarmerSubActMap();
			
			farmerSubActMap.setFarmer(existingFarmer);
			farmerSubActMap.setSubActivity(subActivityRepository.findBySubActCodeAndIsActiveTrue(farmerDtls.getFarmerSubActMapVO().getSubActivity().getSubActCode()));
			farmerSubActMap.setActive(true);
			farmerSubActMapRepository.save(farmerSubActMap);
			
			
			soc.setData(farmerDtl);
		} catch (Exception e) {
			log.error("Exception occurred in manageFarmer()-> FarmerServiceImpl "+ e);	
		}
		return soc;
	}

}
